<!-- Written by: Yun Yan (https://github.com/Puriney) -->


# Initiate the wellDA data

Input:
- the preliminary Signac ATAC data object
- the preliminary Copykit CNA data object

Expected output:
- a folder of wellDA data of the cells with both ATAC and CNA data

## One-step operation

Initiating a wellDA data relies on the [<kbd>scripts/create_coda.initiate.public.R</kbd>](xxx). Browse it for further details. Run it to accomplish initiating a wellDA data. 

In case of that you have multiple samples or experiments, we make it to support running in a `for` loop in a bash file:

``` bash
rcmd='scripts/create_coda.initiate.public.R'
for s in DCIS66T_chip2
do 
  echo $s
  f_obja="rds/${s}_atac/signac/ready.signac_default.rds"
  f_objd="rds/${s}_dna/ready_clean.copykit.rds"
 
  /usr/bin/Rscript $rcmd $s $f_obja $f_objd &
done
wait
echo DONE
```

The R script has 3 parameters: 1) the unique sample name, 2) the file path to the Signac object and 3) the file path to the Copykit object. 

Alternative, you can go through all the processing step by step for each sample, just like we are about to break it down as following **key steps**. 

## 1. Evaluate the extent to which are the two modalities matched

Specify the file path of inputs and read them. 

``` R
run_name <- 'DCIS66T_chip2'
f_obja   <- 'rds/DCIS66T_chip2_atac/ready.signac_default.rds'
f_objd   <- 'rds/DCIS66T_chip2_dna/ready_clean.copykit.rds'
obja     <- read_rds(f_obja)
objd     <- read_rds(f_objd)
cnames_a <- Cells(obja); str(cnames_a)
cnames_d <- colnames(objd); str(cnames_d)
```

Before selecting the cells having both modalities, we suggest always 1) estimating how much is the overlap, and 2) identifying which particular cells do not have both modalities. 


```R
cnames_coda <- intersect(Cells(obja), colnames(objd)); str(cnames_coda)

VennDiagram::venn.diagram(
    list(ATAC=cnames_a, DNA=cnames_d), filename = NULL,
    # col = c('blue', 'gold'), cat.col = c('blue', 'gold'),
    disable.logging=T, cat.default.pos = "text")

pa <- DimPlot(obja, cells.highlight = setdiff(Cells(obja), cnames_coda)) + 
  rremove('legend') + 
  labs(title = 'ATAC', 
       caption = sprintf('%s / %s cells are to be removed', length(setdiff(Cells(obja), cnames_coda)), ncol(obja)))
pa <- pa + theme(aspect.ratio = 1)
colData(objd)$coda_exclude <- !colnames(objd) %in% cnames_coda
pd <- copykit::plotUmap(objd, label = 'coda_exclude') + 
  scale_fill_manual(values = c(`FALSE` = 'grey', `TRUE`='red')) + 
  rremove('legend') + theme(aspect.ratio = 1) + 
  labs(title = 'CNA', 
       caption = sprintf('%s / %s cells are to be removed', sum(colData(objd)$coda_exclude), ncol(objd)))
```

!!img!!

Subset the cells `cnames_coda` having both ATAC and CNA modalities: 

```R
obja <- obja[, cnames_coda]
objd <- objd[, cnames_coda]
```

To facilitate data visualization without loading the data objects which commonly have big file size, we save the cell information and the UMAP coordinates to a separate data frame `coda_metadf`, which is further exported to a CSV file. 

```R
umap_a <- as.data.frame(obja@reductions$umap@cell.embeddings)
colnames(umap_a) <- c('UMAP_1_ATAC', 'UMAP_2_ATAC')
umap_d <- as.data.frame(reducedDim(objd, 'umap'))
colnames(umap_d) <- c('UMAP_1_CNA', 'UMAP_2_CNA')
stopifnot( all.equal( rownames(umap_a), rownames(umap_d) ) )
coda_metadf <- cbind(df_d, df_a, umap_a, umap_d)
coda_metadf$cellname <- cnames_coda
```

## 2. Create analysis-ready wellDA data

### 2.1. ATAC clustering

### 2.2 CNA clustering

